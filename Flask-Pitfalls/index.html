<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Avoiding Common Flask Pitfalls</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="hovercraft.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress"><div class="step" step="0" data-x="0" data-y="0"><h1 id="avoiding-common-flask-pitfalls">Avoiding Common Flask Pitfalls</h1><p>A talk by <a href="https://twitter.com/dirn">@dirn</a></p></div><div class="step" step="1" data-x="1600" data-y="0"><img src="img/pitfall.jpg" alt="" width="" height=""></img></div><div class="step" step="2" data-x="3200" data-y="0"><h1 id="so-you-want-to-use-flask">So you want to use Flask</h1></div><div class="step" step="3" data-x="4800" data-y="0"><p>You've come to the right place!</p></div><div class="step" step="4" data-x="6400" data-y="0"><p><tt>pip install flask</tt></p></div><div class="step" step="5" data-x="8000" data-y="0"><h1 id="application-structure">Application structure</h1></div><div class="step" step="6" data-x="9600" data-y="0"><p><tt>myapp.py</tt></p></div><div class="step has-code" step="7" data-x="11200" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello, Flask-NYC!'</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></pre></div><div class="step" step="8" data-x="12800" data-y="0"><p><em>This doesn't scale</em></p></div><div class="step" step="9" data-x="14400" data-y="0"><p><tt>myapp/__init__.py</tt></p></div><div class="step has-code" step="10" data-x="16000" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span></pre></div><div class="step" step="11" data-x="17600" data-y="0"><p><tt>myapp/views.py</tt></p></div><div class="step has-code" step="12" data-x="19200" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">'Hello, Flask-NYC!'</span></pre></div><div class="step" step="13" data-x="20800" data-y="0"><p><tt>run.py</tt></p></div><div class="step has-code" step="14" data-x="22400" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">app</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></pre></div><div class="step" step="15" data-x="24000" data-y="0"><p><tt>ImportError: cannot import name 'app'</tt></p></div><div class="step" step="16" data-x="25600" data-y="0"><p><strong>Circular import</strong></p></div><div class="step" step="17" data-x="27200" data-y="0"><p><em>The fix</em></p></div><div class="step" step="18" data-x="28800" data-y="0"><p><tt>myapp/__init__.py</tt></p></div><div class="step has-code" step="19" data-x="30400" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="o">*</span> <span class="c"># Move this here.</span></pre></div><div class="step" step="20" data-x="32000" data-y="0"><p>Sometimes you want to spread your views across multiple files.</p></div><div class="step has-code" step="21" data-x="33600" data-y="0"><pre class="highlight code shell"><span class="nv">$ </span>tree myapp/views
views
&#x251C;&#x2500;&#x2500; admin.py
&#x2514;&#x2500;&#x2500; frontend.py</pre></div><div class="step" step="22" data-x="35200" data-y="0"><p><tt>myapp/__init__.py</tt></p></div><div class="step has-code" step="23" data-x="36800" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">myapp.views.frontend</span> <span class="kn">import</span> <span class="o">*</span></pre></div><div class="step has-code" step="24" data-x="38400" data-y="0"><pre class="highlight code shell"><span class="nv">$ </span>curl -I http://0.0.0.0/admin/
HTTP/1.1 <span class="m">404</span> Not Found</pre></div><div class="step" step="25" data-x="40000" data-y="0"><p><em>The fix</em></p></div><div class="step" step="26" data-x="41600" data-y="0"><p>Make sure you include all of your view files.</p></div><div class="step has-code" step="27" data-x="43200" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">myapp.views.admin</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">myapp.views.frontend</span> <span class="kn">import</span> <span class="o">*</span></pre></div><div class="step" step="28" data-x="44800" data-y="0" data-rotate-z="270"><h1 id="forms">Forms</h1></div><div class="step" step="29" data-x="46400" data-y="0" data-rotate-z="270"><p><tt>GET</tt></p></div><div class="step" step="30" data-x="48000" data-y="0" data-rotate-z="270"><p><em>Query String</em></p></div><div class="step has-code" step="31" data-x="49600" data-y="0" data-rotate-z="270"><pre class="highlight code html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"..."</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">value=</span><span class="s">"value"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span></pre></div><div class="step" step="32" data-x="51200" data-y="0" data-rotate-z="270"><pre class="highlight code python"><span class="k">assert</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'value'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'value'</span></pre></div><div class="step" step="33" data-x="52800" data-y="0" data-rotate-z="270"><p><tt>POST</tt></p></div><div class="step" step="34" data-x="54400" data-y="0" data-rotate-z="270"><p><em>Message Body</em></p></div><div class="step has-code" step="35" data-x="56000" data-y="0" data-rotate-z="270"><pre class="highlight code html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"..."</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">value=</span><span class="s">"value"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span></pre></div><div class="step" step="36" data-x="57600" data-y="0" data-rotate-z="270"><pre class="highlight code python"><span class="k">assert</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'value'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'value'</span></pre></div><div class="step" step="37" data-x="59200" data-y="0" data-rotate-z="270"><p><em>Validation</em></p></div><div class="step" step="38" data-x="60800" data-y="0" data-rotate-z="270"><p><tt>pip install flask-wtf</tt></p></div><div class="step has-code" step="39" data-x="62400" data-y="0" data-rotate-z="270"><pre class="highlight code python"><span class="n">form</span> <span class="o">=</span> <span class="n">SomeForm</span><span class="p">()</span>
<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">do_something</span><span class="p">()</span></pre></div><div class="step has-code" step="40" data-x="64000" data-y="0" data-rotate-z="270"><pre class="highlight code python"><span class="n">form</span> <span class="o">=</span> <span class="n">SomeForm</span><span class="p">()</span>
<span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
    <span class="n">do_something</span><span class="p">()</span></pre></div><div class="step" step="41" data-x="65600" data-y="0" data-rotate-z="270"><p><em>Multiple Forms</em></p></div><div class="step has-code" step="42" data-x="67200" data-y="0" data-rotate-z="270"><pre class="highlight code html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{{ url_for('handle_user') }}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h3&gt;</span>Log in<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{{ url_for('handle_user') }}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h3&gt;</span>Register<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"confirm_password"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span></pre></div><div class="step has-code" step="43" data-x="68800" data-y="0" data-rotate-z="270"><pre class="highlight code python"><span class="n">form1</span> <span class="o">=</span> <span class="n">LogInForm</span><span class="p">()</span>
<span class="n">form2</span> <span class="o">=</span> <span class="n">RegisterForm</span><span class="p">()</span>

<span class="c"># Always checked, sometimes true.</span>
<span class="k">if</span> <span class="n">form1</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
    <span class="n">login_in_user</span><span class="p">()</span>
<span class="c"># Sometimes checked, never true.</span>
<span class="k">elif</span> <span class="n">form2</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
    <span class="n">register_user</span><span class="p">()</span></pre></div><div class="step" step="44" data-x="70400" data-y="0" data-rotate-z="270"><p><em>The fix</em></p></div><div class="step has-code" step="45" data-x="72000" data-y="0" data-rotate-z="270"><pre class="highlight code html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"{{ url_for('log_in_user') }}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h3&gt;</span>Login<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;form</span>
  <span class="na">action=</span><span class="s">"{{ url_for('register_user') }}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h3&gt;</span>Register<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"confirm_password"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span></pre></div><div class="step" step="46" data-x="73600" data-y="0" data-rotate-z="0"><h1 id="static-files">Static files</h1></div><div class="step" step="47" data-x="75200" data-y="0"><p><tt>global.js</tt></p></div><div class="step" step="48" data-x="76800" data-y="0"><pre class="highlight code javascript"><span class="nx">alert</span><span class="p">(</span><span class="s1">'Hello Flask-NYC!'</span><span class="p">);</span></pre></div><div class="step has-code" step="49" data-x="78400" data-y="0"><pre class="highlight code python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/index'</span><span class="p">)</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/index/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">)</span></pre></div><div class="step" step="50" data-x="80000" data-y="0"><p><tt>index.html</tt></p></div><div class="step" step="51" data-x="81600" data-y="0"><pre class="highlight code html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"static/js/global.js"</span><span class="nt">&gt;&lt;/script&gt;</span></pre></div><div class="step" step="52" data-x="83200" data-y="0"><img src="img/index.png" alt="" width="" height=""></img></div><div class="step" step="53" data-x="84800" data-y="0"><img src="img/slash-index.png" alt="" width="" height=""></img></div><div class="step" step="54" data-x="86400" data-y="0"><img src="img/slash-index-slash.png" alt="" width="" height=""></img></div><div class="step" step="55" data-x="88000" data-y="0"><p><em>The fix</em></p></div><div class="step has-code" step="56" data-x="89600" data-y="0"><pre class="highlight code html"><span class="nt">&lt;script
  </span><span class="na">src=</span><span class="s">"{{ url_for('static', filename='js/global.js') }}"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span></pre></div><div class="step" step="57" data-x="91200" data-y="0"><pre class="highlight code html"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/static/js/global.js"</span><span class="nt">&gt;&lt;/script&gt;</span></pre></div><div class="step" step="58" data-x="92800" data-y="0"><p>What about dynamic JavaScript?</p></div><div class="step" step="59" data-x="94400" data-y="0"><p><tt>global.js</tt></p></div><div class="step" step="60" data-x="96000" data-y="0"><pre class="highlight code javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">({{</span> <span class="nx">url_for</span><span class="p">(</span><span class="s1">'api.users'</span><span class="p">)</span> <span class="p">}});</span></pre></div><div class="step" step="61" data-x="97600" data-y="0"><p><tt>SyntaxError: Unexpected token {</tt></p></div><div class="step" step="62" data-x="99200" data-y="0"><p><em>The fix</em></p></div><div class="step" step="63" data-x="100800" data-y="0"><p><em>Step one</em></p></div><div class="step" step="64" data-x="102400" data-y="0"><p><tt>global.js</tt></p></div><div class="step" step="65" data-x="104000" data-y="0"><pre class="highlight code javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">urlForUsers</span><span class="p">);</span></pre></div><div class="step" step="66" data-x="105600" data-y="0"><p><tt>template.html</tt></p></div><div class="step" step="67" data-x="107200" data-y="0"><pre class="highlight code javascript"><span class="kd">var</span> <span class="nx">urlForUsers</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">url_for</span><span class="p">(</span><span class="s1">'api.users'</span><span class="p">)</span> <span class="p">}};</span></pre></div><div class="step" step="68" data-x="108800" data-y="0"><p><tt>SyntaxError: Invalid flags supplied to RegExp constructor 'users'</tt></p></div><div class="step" step="69" data-x="110400" data-y="0"><p><strong>WAT?!</strong></p></div><div class="step" step="70" data-x="112000" data-y="0"><pre class="highlight code javascript"><span class="kd">var</span> <span class="nx">urlForUsers</span> <span class="o">=</span> <span class="err">/api/users;</span></pre></div><div class="step" step="71" data-x="113600" data-y="0"><p><em>The fix</em></p></div><div class="step" step="72" data-x="115200" data-y="0"><p><em>Step two</em></p></div><div class="step" step="73" data-x="116800" data-y="0"><pre class="highlight code javascript"><span class="kd">var</span> <span class="nx">urlForUsers</span> <span class="o">=</span> <span class="s1">'{{ url_for('</span><span class="nx">api</span><span class="p">.</span><span class="nx">users</span><span class="s1">') }}'</span><span class="p">;</span></pre></div><div class="step" step="74" data-x="118400" data-y="0"><pre class="highlight code javascript"><span class="kd">var</span> <span class="nx">urlForUsers</span> <span class="o">=</span> <span class="s1">'/api/users'</span><span class="p">;</span></pre></div><div class="step" step="75" data-x="120000" data-y="0"><p><em>The fix</em></p></div><div class="step" step="76" data-x="121600" data-y="0"><p><em>Even better!</em></p></div><div class="step" step="77" data-x="123200" data-y="0"><pre class="highlight code javascript"><span class="kd">var</span> <span class="nx">urlForUsers</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">url_for</span><span class="p">(</span><span class="s1">'api.users'</span><span class="p">)</span><span class="o">|</span><span class="nx">tojson</span><span class="o">|</span><span class="nx">safe</span> <span class="p">}};</span></pre></div><div class="step" step="78" data-x="124800" data-y="0"><pre class="highlight code javascript"><span class="kd">var</span> <span class="nx">urlForUsers</span> <span class="o">=</span> <span class="s2">"/api/users"</span><span class="p">;</span></pre></div><div class="step" step="79" data-x="126400" data-y="0" data-rotate-z="270"><h1 id="production-errors">Production errors</h1></div><div class="step" step="80" data-x="128000" data-y="0" data-rotate-z="270"><img src="img/500.png" alt="" width="" height=""></img></div><div class="step" step="81" data-x="129600" data-y="0" data-rotate-z="270"><p><em>The fix</em></p></div><div class="step" step="82" data-x="131200" data-y="0" data-rotate-z="270"><p><strong>Check the logs</strong></p></div><div class="step" step="83" data-x="132800" data-y="0" data-rotate-z="0"><h1 id="flask-ecosystem">Flask ecosystem</h1></div><div class="step" step="84" data-x="134400" data-y="0"><p>I want to learn how to do it...</p></div><div class="step" step="85" data-x="136000" data-y="0"><p>I don't want another dependency...</p></div><div class="step" step="86" data-x="137600" data-y="0"><p>Not Invented Here</p></div><div class="step" step="87" data-x="139200" data-y="0"><h1 id="flask-security"><tt>Flask-Security</tt></h1><p><a href="https://pythonhosted.org/Flask-Security/">pythonhosted.org/Flask-Security/</a></p></div><div class="step" step="88" data-x="140800" data-y="0"><h1 id="flask-sqlalchemy"><tt>Flask-SQLAlchemy</tt></h1><p><a href="https://pythonhosted.org/Flask-SQLAlchemy/">pythonhosted.org/Flask-SQLAlchemy/</a></p></div><div class="step" step="89" data-x="142400" data-y="0" data-rotate-z="270"><h1 id="internal-requests">Internal requests</h1></div><div class="step has-code" step="90" data-x="144000" data-y="0" data-rotate-z="270"><pre class="highlight code python"><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">friends</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s">'http://localhost:5000/api/friends'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="n">friends</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></pre></div><div class="step" step="91" data-x="145600" data-y="0" data-rotate-z="270"><img src="img/loading.gif" alt="" width="" height=""></img></div><div class="step" step="92" data-x="147200" data-y="0" data-rotate-z="270"><p><strong>Single Threaded</strong></p></div><div class="step" step="93" data-x="148800" data-y="0" data-rotate-z="270"><p><em>The fix</em></p></div><div class="step" step="94" data-x="150400" data-y="0" data-rotate-z="270"><p>Application server</p></div><div class="step" step="95" data-x="152000" data-y="0" data-rotate-z="270"><p><a href="https://uwsgi-docs.readthedocs.org/en/latest/">uWSGI</a></p><p><a href="http://gunicorn.org/">gunicorn</a></p><p><a href="https://modwsgi.readthedocs.org/en/master/">mod_wsgi</a></p></div><div class="step" step="96" data-x="153600" data-y="0" data-rotate-z="0"><h1 id="context-is-king">Context is king</h1></div><div class="step" step="97" data-x="155200" data-y="0"><p>"I have a long running job that I want to run in the background."</p></div><div class="step" step="98" data-x="156800" data-y="0"><p>"Use Celery"</p></div><div class="step" step="99" data-x="158400" data-y="0"><p><tt>myapp/__init__.py</tt></p></div><div class="step has-code" step="100" data-x="160000" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span>

<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">()</span>
<span class="n">mail</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></pre></div><div class="step" step="101" data-x="161600" data-y="0"><p><tt>tasks.py</tt></p></div><div class="step has-code" step="102" data-x="163200" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">mail</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre></div><div class="step" step="103" data-x="164800" data-y="0"><p><tt>myapp/views.py</tt></p></div><div class="step" step="104" data-x="166400" data-y="0"><pre class="highlight code python"><span class="n">send_mail</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre></div><div class="step" step="105" data-x="168000" data-y="0"><p><tt>RuntimeError: working outside of application context</tt></p></div><div class="step" step="106" data-x="169600" data-y="0"><p><em>The fix</em></p></div><div class="step" step="107" data-x="171200" data-y="0"><pre class="highlight code python"><span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></pre></div><div class="step has-code" step="108" data-x="172800" data-y="0"><pre class="highlight code python"><span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mail</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">send_mail</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></pre></div><div class="step" step="109" data-x="174400" data-y="0" data-rotate-z="270"><p><em>Questions?</em></p></div></div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Left, Down, Page Down</th><td>Next slide</td></tr><tr><th>Right, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>